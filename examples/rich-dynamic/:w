goog.require('ldc');

window.onload = function(event) {
    var MSG_BOARD_ID = "message-board";
    var SHAPE_INPUT_ID = "shape-file-input";
    var CANVAS_ID = "waveform-canvas";
    var CANVAS_W = 800;
    var CANVAS_H = 200;
    var BACK_BTN_ID = "back-btn";
    var FORWARD_BTN_ID = "forward-btn";
    var ZOOMIN_BTN_ID = "zoomin-btn";
    var ZOOMOUT_BTN_ID = "zoomout-btn";
    var CURSOR_POS_ID = "cursor-pos";
    var MIN_DUR = 5;

    var app = {
        init: function() {
            // event bus: This is used to listen on waveform events. If supplied,
            // waveform sends out event via the event bus. Client can register
            // event handlers with the event bus.
            this.ebus = new ldc.event.EventBus;
            // listen on waveform cursor event (user moves cursor on the waveform)
            this.ebus.connect(ldc.waveform.WaveformCursorEvent, this.cursor_pos_handler);

            // initialize canvas on which the waveform will be drawn
            this.canvas = document.getElementById(CANVAS_ID);
            this.canvas.width = CANVAS_W;
            this.canvas.height = CANVAS_H;

            // listen on file chooser event
            document.getElementById(SHAPE_INPUT_ID)
            .addEventListener("change", function() {
                app.load_shape_file(this.files[0]);
            });

            // listen on the "backward" button
            document.getElementById(BACK_BTN_ID)
            .addEventListener("click", function() {
                app.rewind(1);
            });

            // listen on the "forward" button
            document.getElementById(FORWARD_BTN_ID)
            .addEventListener("click", function() {
                app.forward(1);
            });

            // listen on the "zoom in" button
            document.getElementById(ZOOMIN_BTN_ID)
            .addEventListener("click", function() {
                app.resize(0.8);
            });

            // listen on the "zoom out" button
            document.getElementById(ZOOMOUT_BTN_ID)
            .addEventListener("click", function() {
                app.resize(1.25);
            });
        },

        load_shape_file: function(file) {
            // turn the file object into a url object, which we can treat
            // like a url on a remote server
            var url_obj = URL.createObjectURL(file);

            var callback = function(audio_buffer) {
                // create shape file dynamically from downloaded and decoded audio 
                // data. Take only the first channel.
                var shape_data = ldc.waveform.Utils.makeShapeFile(
                    CANVAS_W, MIN_DUR, audio_buffer, 1);

                // this is how the waveform widget is used
                // 1) create a buffer object with the uploaded shape file
                // 2) create a waveform object using the buffer
                // 3) display a region of the created waveform
                var buffer = new ldc.waveform.WaveformBuffer(shape_data);
                app.waveform = new ldc.waveform.RichWaveform(buffer, app.canvas, 0, app.ebus);
                app.waveform.display(0, 60);
            };

            Utils.download(url_obj, "array_buffer")
            .then(function(data) {
                var context = new webKitAudioContext;
                context.decodeAudioData(data, callback, function() {
                    app.log("audio decoding error");
                }
            }))
            .fail(function(e) {

                // failed to obtain the shape file
                app.log("failed to load audio file<br>");

            });
        },

        log: function(msg) {
            var msg_board = document.getElementById(MSG_BOARD_ID);
            msg_board.innerHTML += msg;
        },

        rewind: function(n) {
            var t = Math.max(this.waveform.windowStartTime() - n, 0);
            this.waveform.moveWindow(t);
        },

        forward: function(n) {
            var t = Math.min(this.waveform.windowStartTime() + n, this.waveform.length());
            this.waveform.moveWindow(t);
        },

        resize: function(ratio) {
            var t = this.waveform.windowStartTime();
            var w0 = this.waveform.windowDuration();
            var w = w0 * ratio;
            this.waveform.display(t, w);
        },

        cursor_pos_handler: {
            handleEvent: function(e) {
                if (e instanceof ldc.waveform.WaveformCursorEvent) {
                    document.getElementById(CURSOR_POS_ID).innerHTML = e.args();
                }
            }
        }
    }

    app.init();
}

